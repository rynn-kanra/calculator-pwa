var D=Symbol("Comlink.optionalChaining"),n=Symbol("Comlink.proxyRemoteData"),l=Symbol("Comlink.proxy"),R=Symbol("Comlink.thrown"),m=crypto.getRandomValues(new Uint8Array(6)).reduce((G,B)=>G*256+B,0),L=new Map,h=new Map;function j(G){return G.constructor.name==="MessagePort"}function c(G){if(j(G))G.close()}var d=new WeakMap;function i(G,B){return d.set(G,B),G}async function P(G,B){for(let[J,N]of h)if(N.canHandle(B)){let[K,Q]=await N.serialize(B,G);return[{type:-2,name:J,value:K},Q]}return[{type:-1,value:B},d.get(B)||[]]}async function V(G,B){switch(B.type){case-2:return await h.get(B.name).deserialize(B.value,G);case-1:return B.value}}var p=D.toString(),a=new Map([[Symbol.asyncIterator.toString(),Symbol.asyncIterator]]),t=typeof SharedWorkerGlobalScope<"u"&&globalThis instanceof SharedWorkerGlobalScope,I=new WeakMap,f=new WeakMap,C=new Map;function y(G,B=globalThis,J=["*"],N){let K=C.get(B);if(!K){if(!t)N=void 0;if(K={proxyIdMap:new Map,callback:async function(Z){if(!Z||!Z.data)return;if(!o(J,Z.origin))return;let{id:z,type:F}=Z.data;if(typeof z!=="number"||typeof F!=="number"||F<=-1)return;let q=Z.data.path??[],W=Z.data.pid??0;if(W===0)W=K.proxyIdMap.keys().next().value??0;let k=await Promise.all((Z.data.argumentList||[]).map(($)=>V(B,$))),_,U;try{let $,T;if(q.length===0)U=T=K.proxyIdMap.get(W),$=void 0;else{U=K.proxyIdMap.get(W);let Y=GB(U,q);U=Y.parent,T=Y.value,$=q[q.length-1]}switch(F){case 0:_=void 0;break;case 1:{let Y=Z.data.tid;L.set(Y,B),K.tid=Y,_={tid:m,timeout:N&&Math.floor(N/3)}}break;case 2:{let{tid:Y}=Z.data,M=L.get(Y),{proxyIdMap:x}=C.get(M);for(let[w,s]of K.proxyIdMap)if(!x.has(w))x.set(w,s);_=void 0}break;case 3:_=T;break;case 4:U[$]=await V(B,Z.data.value),_=!0;break;case 5:{let Y=a.get($);if(Y)switch(Y){case Symbol.asyncIterator:{if(Symbol.asyncIterator in U)T=U[Symbol.asyncIterator];else T=U[Symbol.iterator];_=y(T.apply(U,k),B);break}}else _=T.apply(U,k)}break;case 6:{let Y=new T(...k);_=v(Y)}break;case 7:{let{port1:Y,port2:M}=new MessageChannel;y(U,M),_=i(Y,[Y])}break;case 8:if(!N)_=void 0;else if(clearTimeout(K.timeout),Z.data.lock)navigator.locks.request(Z.data.lock,()=>{E(B)}),K.timeout=void 0,_=void 0;else K.timeout=setTimeout(()=>{E(B)},N),_=Math.floor(N/3);break;case 9:_=void 0;break;default:return}}catch($){_={value:$,[R]:0}}Promise.resolve(_).catch(($)=>{return{value:$,[R]:0}}).then(async($)=>{let[T,Y]=await P(B,$);switch(T.id=z,B.postMessage(T,Y),F){case 9:{E(B,[U]);break}case 2:{E(B);break}}}).catch(async($)=>{let[T,Y]=await P(B,{value:TypeError("Unserializable return value",{cause:$}),[R]:0});T.id=z,B.postMessage(T,Y)})}},C.set(B,K),B.addEventListener("message",K.callback),B.start)B.start();if(N)K.timeout=setTimeout(function(){E(B)},N);if(!j(B))B.postMessage({id:0,type:-1})}let Q=v(G),X=e(Q).pid;return K.proxyIdMap.set(X,G),I.get(G).count++,Q}function E(G=globalThis,B){let J=C.get(G);if(!J)return;let N=J.proxyIdMap;if(!B)B=Array.from(N.values());for(let X of B){let S=I.get(X),Z=S.pid;if(!N.has(Z))continue;if(N.delete(Z),S.count--,S.count===0){if(Symbol.asyncDispose in X&&typeof X[Symbol.asyncDispose]==="function")X[Symbol.asyncDispose]();else if(Symbol.dispose in X&&typeof X[Symbol.dispose]==="function")X[Symbol.dispose]()}}if(N.size>0)return;let{callback:K,timeout:Q,tid:H}=J;K&&G.removeEventListener("message",K),c(G),C.delete(G),H&&L.delete(H),typeof Q<"u"&&clearTimeout(Q)}function o(G,B){for(let J of G){if(B===J||J==="*")return!0;if(J instanceof RegExp&&J.test(B))return!0}return!1}function v(G){if(f.has(G))return G;let B=I.get(G);if(!B)B={proxy:void 0,count:0},I.set(G,B);if(!B.proxy)B.proxy=BB(G)?G:new Proxy(G,{}),f.set(B.proxy,{obj:G});return B.proxy}var r=1;function e(G){let B=f.get(G);if(typeof B.pid!=="number")B.pid=r++,I.get(B.obj).pid=B.pid;return B}function BB(G){return f.has(G)||G?.[l]||typeof G==="function"}function GB(G,B){let J=!1,N=G;for(let K=0,Q=B.length;K<Q;K++){let H=B[K];if(!J&&(N===null||N===void 0))break;if(H===p){J=!0;continue}if(G=N,N=J?N?.[H]:N[H],J&&N!==void 0&&N!==null)J=!1}return{parent:G,value:N}}var JB=new WeakMap,KB=()=>navigator&&("locks"in navigator)&&typeof navigator.locks?.request==="function";class u{ep;messageIdSequence=1;pendingListeners=new Map;isReady=!1;queue=[];heartBeat;tid;pidRemoteMap=new Map;constructor(G){this.ep=G,this.handler=this.handler.bind(this),this.initialize()}getRemote(G){return this.pidRemoteMap.get(G)?.remote?.deref()}async unregister(G){let B=this.pidRemoteMap.get(G);if(B){if(B.count--,B.count===0){this.pidRemoteMap.delete(G);try{await this.requestResponse({type:9,pid:G})}catch{}finally{if(this.pidRemoteMap.size===0)this.ep.removeEventListener("message",this.handler),c(this.ep),this.heartBeat??clearTimeout(this.heartBeat),this.pendingListeners.clear(),this.queue=void 0,this.tid&&L.delete(this.tid)}}}return this.pidRemoteMap.size===0}register(G,B,J){if(JB.set(G,B),!this.pidRemoteMap.has(B))this.pidRemoteMap.set(B,{remote:new WeakRef(G),count:0});let N=this.pidRemoteMap.get(B);if(J&&!N.remote.deref())N.remote=new WeakRef(G);N.count++}get(G,B){return this.requestResponse({type:3,pid:G,path:B.map((J)=>J.toString())})}async set(G,B,J){if(J instanceof Promise)J=await J;let[N,K]=await P(this.ep,J);return await this.requestResponse({type:4,pid:G,path:B.map((Q)=>Q.toString()),value:N},K)}async apply(G,B,J){let[N,K]=await this.processArguments(this.ep,J);return this.requestResponse({type:5,pid:G,path:B.map((Q)=>Q.toString()),argumentList:N},K)}async construct(G,B,J){let[N,K]=await this.processArguments(this.ep,J);return this.requestResponse({type:6,pid:G,path:B.map((Q)=>Q.toString()),argumentList:N},K)}createEndPoint(G){return this.requestResponse({type:7,pid:G})}requestResponse(G,B){return new Promise((J)=>{if(G.id=this.messageIdSequence++,this.isReady)this.ep.postMessage(G,B);else this.queue?.push([G,B]);this.pendingListeners.set(G.id,J)}).then((J)=>V(this.ep,J))}async processArguments(G,B){return(await Promise.all(B.map((K)=>P(G,K)))).reduce((K,Q)=>{if(K[0].push(Q[0]),Array.isArray(Q[1]))K[1].push(...Q[1]);return K},[[],[]])}initialize(){if(this.ep.addEventListener("message",this.handler),this.ep.start)this.ep.start();if(this.isReady=j(this.ep),this.isReady)this.queue=void 0;else this.pendingListeners.set(0,async()=>{this.isReady=!0;let G=this.queue;if(this.queue=void 0,G)for(let B of G)this.ep.postMessage(B[0],B[1])}),this.ep.postMessage({id:0,type:0});this.sendTID()}async handler(G){let B=G.data;if(!B||typeof B.id!=="number"||B.type>=0)return;let J=this.pendingListeners.get(B.id);if(!J)return;try{J(B)}finally{this.pendingListeners.delete(B.id)}}async sendTID(){let G=await this.requestResponse({type:1,tid:m});if(this.tid=G.tid,L.set(G.tid,this.ep),G.timeout)if(KB()){let B=`Comlink.id:${Date.now()}:${Math.random()*Number.MAX_SAFE_INTEGER}`;navigator.locks.request(B,{mode:"exclusive"},()=>new Promise(()=>{})),this.requestResponse({type:8,lock:B})}else this.sendHeartBeat(G.timeout)}sendHeartBeat(G){if(typeof G!=="number"||G<=0)return;this.heartBeat??clearTimeout(this.heartBeat),this.heartBeat=setTimeout(()=>{this.requestResponse({type:8}).then((B)=>this.sendHeartBeat(B))},G)}}var A=!("FinalizationRegistry"in globalThis)?void 0:new FinalizationRegistry(([G,B])=>setTimeout(()=>G.unregister(B))),b=new Map,NB=function(){};function O(G){if(G)throw Error("Proxy has been released and is not useable")}function XB(G){let B=QB(G);return g(B,0)}function QB(G,B=!0){let J=b.get(G);if(B&&!J)J=new u(G),b.set(G,J);return J}function g(G,B,J=[]){let N={controller:G,pid:B,path:J},K=!1,Q=new Proxy(NB,{get(H,X){if(O(K),X===Symbol.asyncDispose)return async()=>{if(A)A.unregister(Q);try{await G.unregister(B)}finally{K=!0}};if(X===n)return N;if(X==="then"){if(J.length>0&&J[J.length-1]===D)J=J.slice(0,-1);if(J.length===0)return{then:()=>Q};let S=G.get(B,J);return S.then.bind(S)}return g(G,B,[...J,X])},set(H,X,S){return O(K),G.set(B,[...J,X],S)},apply(H,X,S){O(K);let Z=J[J.length-1];if(Z==="bind")return g(G,B,J.slice(0,-1));if(Z===Symbol.asyncIterator){let z,F=async()=>{if(!z)z=await G.apply(B,J,[]);return z};return{async next(q){return(await F()).next(q)},async return(q){return(await F()).return[D](q)},async throw(q){return(await F()).throw[D](q)}}}return G.apply(B,J,S)},construct(H,X){return O(K),G.construct(B,J,X)}});if(G.register(Q,B,J.length===0),A)A.register(Q,[G,B],Q);return Q}
export{i as L,y as M,v as N,XB as O};
